generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Avito Accounts (credentials для работы с API)
model AvitoAccount {
  id                      Int       @id @default(autoincrement())
  name                    String    @unique        // Название аккаунта
  clientId                String    @map("client_id")
  clientSecret            String    @map("client_secret")
  userId                  String?   @map("user_id")
  
  // Proxy settings
  proxyType               String?   @map("proxy_type")      // 'http', 'https', 'socks4', 'socks5'
  proxyHost               String?   @map("proxy_host")
  proxyPort               Int?      @map("proxy_port")
  proxyLogin              String?   @map("proxy_login")
  proxyPassword           String?   @map("proxy_password")
  
  // Status tracking
  connectionStatus        String?   @default("not_checked") @map("connection_status")
  proxyStatus             String?   @default("not_checked") @map("proxy_status")
  
  // Statistics
  accountBalance          Float?    @default(0) @map("account_balance")
  adsCount                Int?      @default(0) @map("ads_count")
  viewsCount              Int?      @default(0) @map("views_count")
  contactsCount           Int?      @default(0) @map("contacts_count")
  viewsToday              Int?      @default(0) @map("views_today")
  contactsToday           Int?      @default(0) @map("contacts_today")
  lastSyncAt              DateTime? @map("last_sync_at")
  
  // Eternal Online
  eternalOnlineEnabled    Boolean?  @default(false) @map("eternal_online_enabled")
  isOnline                Boolean?  @default(false) @map("is_online")
  lastOnlineCheck         DateTime? @map("last_online_check")
  onlineKeepAliveInterval Int?      @default(300) @map("online_keep_alive_interval")  // seconds
  
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")
  
  chats                   AvitoChat[] @relation("AccountChats")
  
  @@map("avito_account")
  @@index([name])
}

// Avito chats
model AvitoChat {
  id              Int       @id @default(autoincrement())
  chatId          String    @unique @map("chat_id")    // Уникальный ID чата от Avito
  accountId       Int?      @map("account_id")          // Связь с аккаунтом
  city            String?                               // Город
  name            String?                               // Имя клиента
  phone           String?                               // Телефон клиента
  lastMessage     String?   @map("last_message")        // Последнее сообщение
  status          String?   @default("active")          // 'active', 'closed', 'archived'
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  account         AvitoAccount? @relation("AccountChats", fields: [accountId], references: [id])
  orders          Order[]
  messages        AvitoMessage[]
  
  @@map("avito_chat")
  @@index([chatId])
  @@index([phone])
  @@index([accountId])
}

// Avito messages history
model AvitoMessage {
  id              Int       @id @default(autoincrement())
  chatId          String    @map("chat_id")             // ID чата
  messageId       String    @unique @map("message_id")  // ID сообщения от Avito
  direction       String                                // 'inbound' | 'outbound'
  content         String                                // Текст сообщения
  authorId        String?   @map("author_id")           // ID автора (от Avito)
  createdAt       DateTime  @default(now()) @map("created_at")
  
  chat            AvitoChat @relation(fields: [chatId], references: [chatId])
  
  @@map("avito_message")
  @@index([chatId])
  @@index([createdAt])
}

// Related models
model Order {
  id                    Int       @id @default(autoincrement())
  rk                    String
  city                  String
  avitoName             String?
  phone                 String
  typeOrder             String
  clientName            String
  address               String
  dateMeeting           String
  typeEquipment         String
  problem               String
  callRecord            String?
  statusOrder           String
  masterId              Int?
  result                Int?
  expenditure           Int?
  clean                 Int?
  masterChange          Int?
  bsoDoc                String?
  expenditureDoc        String?
  operatorNameId        Int
  createDate            DateTime  @default(now())
  closingData           String?
  avitoChatId           String?
  callId                String?
  prepayment            Int?
  dateClosmod           String?
  comment               String?
  cashSubmissionStatus  String?
  cashSubmissionDate    DateTime?
  cashSubmissionAmount  Int?
  cashReceiptDoc        String?
  cashApprovedBy        Int?
  cashApprovedDate      DateTime?
  directorId            Int?
  callcentreAdminId     Int?
  callcentreOperatorId  Int?
  
  avitoChat             AvitoChat?           @relation(fields: [avitoChatId], references: [chatId])
  
  @@map("order")
}



